<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Off main thread HTML parsing in Servo | Nikhil Shagrithaya </title> <meta name="author" content="Nikhil Shagrithaya"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%92%BE&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nikhilshagri.github.io/blog/2017/gsoc-project/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span>Nikhil</span> Shagrithaya </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/links/">links </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Off main thread HTML parsing in Servo</h1> <p class="post-meta"> Created on August 23, 2017 </p> <p class="post-tags"> <a href="/blog/2017"> <i class="fa-solid fa-calendar fa-sm"></i> 2017 </a>   ·   <a href="/blog/category/programming"> <i class="fa-solid fa-tag fa-sm"></i> programming</a>   <a href="/blog/category/gsoc"> <i class="fa-solid fa-tag fa-sm"></i> gsoc</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="introduction">Introduction</h2> <p>Traditionally, browsers have been written as single threaded applications, and the html spec certainly seems to validate this statement. This makes it difficult to parallelize any task which a browser carries out, and we generally have to come up with innovative ways to do so.</p> <p>One such task is HTML parsing, and I have been working on parallelizing it this summer as part of my GSoC project. Since Servo is written in Rust, I’m assuming the reader has some basic knowledge about Rust. If not, check out this awesome <a href="https://doc.rust-lang.org/book/second-edition/" rel="external nofollow noopener" target="_blank">Rust book</a>. Done? Let’s dive straight into the details:</p> <h3 id="html-parser">HTML Parser</h3> <p>Servo’s HTML (and XML) parsing code live in <a href="https://github.com/servo/html5ever" rel="external nofollow noopener" target="_blank">html5ever</a>. Since this project concerns HTML parsing, I will only be talking about that. The first component we need to know about is the <code class="language-plaintext highlighter-rouge">Tokenizer</code>. This component is responsible for taking in raw input from a buffer and creating tokens, eventually sending them to its Sink, which we will call <code class="language-plaintext highlighter-rouge">TokenSink</code>. This could be any type which implements the <code class="language-plaintext highlighter-rouge">TokenSink</code> trait.</p> <p>html5ever has a type called <code class="language-plaintext highlighter-rouge">TreeBuilder</code>, which implements this trait. The TreeBuilder’s job is to create tree operations based on the tokens it receives. TreeBuilder contains its own Sink, called <a href="https://doc.servo.org/markup5ever/interface/tree_builder/trait.TreeSink.html" rel="external nofollow noopener" target="_blank">TreeSink</a>, which details the methods corresponding to these tree ops. The TreeBuilder calls these <code class="language-plaintext highlighter-rouge">TreeSink</code> methods under appropriate conditions, and these ‘action methods’ are responsible for constructing the DOM tree.</p> <p>With me so far? Good. The key to parallelizing HTML parsing is realizing that the task of creating tree ops is independent from the task of <em>actually</em> executing them to construct the DOM tree. Therefore, tokenization and tree op creation can happen on a separate thread, while the tree construction can be done on the main thread itself.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/parsing_diagram-480.webp 480w,/assets/img/parsing_diagram-800.webp 800w,/assets/img/parsing_diagram-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/parsing_diagram.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Information flow in both models: a comparision. </div> <h3 id="the-process">The Process</h3> <p>The first step I took was to decouple tree op creation from tree construction. Previously, tree ops were executed as soon as they were created. This involved the creation of a new <a href="https://github.com/servo/servo/blob/master/components/script/dom/servoparser/async_html.rs#L512" rel="external nofollow noopener" target="_blank">TreeSink</a>, which instead of executing them directly, created a <a href="https://github.com/servo/servo/blob/master/components/script/dom/servoparser/async_html.rs#L59-L105" rel="external nofollow noopener" target="_blank">representation</a> of a tree op, containing all relevant data. For the time being, I sent the tree op to a <code class="language-plaintext highlighter-rouge">process_op</code> function as soon as it was created, whereupon it was executed.</p> <p>Now that these two processes were independent, my next task consisted of creating a new thread, where the Tokenizer+TreeBuilder pair would live, to generate these tree ops. Now, when a tree op was created, it would be sent to the main thread, and control would return back to the TreeBuilder. The TreeBuilder does not have to wait for the execution of the tree op anymore, thus speeding up the entire process.</p> <p>So far so good. The final task in this project was to implement speculative parsing, by building on top of these recent changes.</p> <h3 id="speculative-parsing">Speculative Parsing</h3> <p>The HTML spec dictates that at any point during parsing, if we encounter a script tag, then the script must be executed immediately (if it is an inline script), or must be fetched and then executed (note that this rule does not apply to <code class="language-plaintext highlighter-rouge">async</code> or <code class="language-plaintext highlighter-rouge">defer</code> scripts). Why, you might ask, must this be done so? Why can’t we mark these scripts and execute them all at the end, after the parsing is done? This is because of an old, ill-thought out <code class="language-plaintext highlighter-rouge">Document</code> API function called <code class="language-plaintext highlighter-rouge">document.write()</code>. This function is a pain point for many developers who work on browsers, as it is a real headache implementing it well enough, while working around the many idiosyncrasies which surround it. I won’t dive into the details here, as they are not relevant. All we need to know is what <code class="language-plaintext highlighter-rouge">document.write()</code> does: it takes a string argument, which is generally markup, and inserts this string as part of the document’s HTML content. It is suffice to say that using this function might break your page, and should not be used.</p> <p>Returning to the parsing task, we can’t commit any DOM manipulations until the script finishes executing, because <code class="language-plaintext highlighter-rouge">document.write()</code> could make them redundant. What speculative parsing aims to do is to continue parsing the content after the script tag in the parser thread, while the script is being executed in the main thread. Note that we are only speculatively creating tree ops here, not the actual tree construction. After the script finishes executing, we analyze the actions of the <code class="language-plaintext highlighter-rouge">document.write()</code> calls (if any) to determine whether to use the tree ops, or to throw them away.</p> <h3 id="roadblock">Roadblock!</h3> <p>Remember when I said the process of creating tree ops is independent from tree construction? Well, I lied a little. Until a week ago, we need access to some DOM nodes for the creation of a couple of tree actions (one method needed to know if a node had a parent, and the other needed to know whether two nodes existed in the same tree). When I moved the task of creating tree ops to a separate thread, I could no longer access the DOM tree, which lived on the main thread. So I used a <code class="language-plaintext highlighter-rouge">Sender</code> on the TreeSink to create and send <a href="https://github.com/servo/servo/pull/17565/files#diff-10b46cb1e26142d2058e291de25bd4c7R133" rel="external nofollow noopener" target="_blank">queries</a> to the main thread, which would access the DOM and send the results back. Then only would the TreeSink method return, with the data it received from the main thread. Additionally, this meant that these couple of methods were synchronous in nature. No biggie.</p> <p>I realized the problem when I sat down to think about how I would implement speculative parsing. Since the main thread is busy executing scripts, it won’t be listening to the queries these synchronous methods will be sending, and therefore the task of creating tree ops cannot progress further!</p> <p>This turned out to be a bigger problem than I’d imagined, and I also had to sift through the equivalent Gecko code to understand how this situation was handled. I eventually came up with a good solution, but I won’t bore you with the details. If you want to know more, here’s a <a href="https://gist.github.com/nikhilshagri/09fb8a6dd1db58852d2085ac59ca0f9b" rel="external nofollow noopener" target="_blank">gist</a> explaining the solution.</p> <p>With these changes landed in html5ever, I can finally implement speculative parsing. Unfortunately, there’s not much time to implement it as a part of the GSoC project, so I will be landing this feature in Servo some time later. I hope to publish another blog post describing it thoroughly, along with details on the performance improvements this feature would bring.</p> <h4 id="links-to-important-prs">Links to important PRs:</h4> <p>Added Async HTML Tokenizer: <a href="https://github.com/servo/servo/pull/17037" rel="external nofollow noopener" target="_blank">https://github.com/servo/servo/pull/17037</a></p> <p>Run the async HTML Tokenizer on a new thread: <a href="https://github.com/servo/servo/pull/17914" rel="external nofollow noopener" target="_blank">https://github.com/servo/servo/pull/17914</a></p> <p>TreeBuilder no longer relies on <code class="language-plaintext highlighter-rouge">same_tree</code> and <code class="language-plaintext highlighter-rouge">has_parent_node</code>: <a href="https://github.com/servo/html5ever/pull/300" rel="external nofollow noopener" target="_blank">https://github.com/servo/html5ever/pull/300</a></p> <p>End TreeBuilder’s reliance on DOM: <a href="https://github.com/servo/servo/pull/18056" rel="external nofollow noopener" target="_blank">https://github.com/servo/servo/pull/18056</a></p> <h2 id="conclusion">Conclusion</h2> <p>This was a really fun project; I got to solve lots of cool problems, and also learnt a lot more about how a modern, spec-compliant rendering engine works.</p> <p>I would like to thank my mentor <a href="https://twitter.com/nokusu" rel="external nofollow noopener" target="_blank">Anthony Ramine</a>, who was absolutely amazing to work with, and <a href="https://twitter.com/lastontheboat" rel="external nofollow noopener" target="_blank">Josh Matthews</a>, who helped me a lot when I was still a rookie looking to contribute to the project.</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Nikhil Shagrithaya. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: July 11, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?f7ef567d107f4a52f2afec8496403fc6"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> </body> </html>